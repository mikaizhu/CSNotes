<!--ts-->
* [操作系统](#操作系统)
* [第一回](#第一回)
* [第二回](#第二回)
* [第三回](#第三回)
* [第四回](#第四回)

<!-- Added by: zwl, at: Thu Mar  3 11:49:26 CST 2022 -->

<!--te-->
# 操作系统

推荐教程：
- [哈工大操作系统 [MOOC]](https://www.icourse163.org/learn/HIT-1002531008?tid=1450346461#/learn/content?type=detail&id=1214728532&cid=1218670721&replay=true) 
- [哈工大操作系统
  [bilibili]](https://www.bilibili.com/video/BV1d4411v7u7?from=search&seid=8612787840369428117&spm_id_from=333.337.0.0) 
- [品读操作系统源码](https://github.com/sunym1993/flash-linux0.11-talk) 

# 第一回

在电脑开机到启动，经历了下面几个过程：
- 开机的时候，电脑主板上写死的BIOS(Basic Input Output System)程序会自动运行
- BIOS会将存储在硬盘上的操作系统，拷贝到内存的0x7c00，这个地址由电脑架构决定
- 电脑从该地址开始，一行一行执行命令

> 注意：
>
> 1. 操作系统肯定是先存储在硬盘中的
>
> 2. 代码执行肯定是在内容中的，并且执行方式为**取指执行** 
>
> 3. 该部分bootsect.s 汇编文件控制
>
> 4. ds寄存器的值为0x07c0，之后的代码，段基地址都要先左移动4位，这就变成了0x7c00,
> 所以之后的9000->90000都是这个原理,
> ds是段基寄存器，后面的地址都是在这个基础上偏移

[reference](https://mp.weixin.qq.com/s/LIsqRX51W7d_yw-HN-s2DA) 


[【↥ back to top】](#目录)
# 第二回

从上回开始，开机后，操作系统开始执行命令了，命令如下：
- 将各个寄存器赋值[ds:0x9000, es:0x9000, cx:256, si:0, di:0]
- 将ds开始往下的512字节的内容，复制到0x90000处(为啥是512字节？`rep movw`
  命令表示复制一个字，每个字是16位，也就是2字节，重复该命令256次，)
- 程序从0x9000 + go标记的偏移地址开始执行剩下的代码

可以看到，第二回的代码就是将程序移动了个位置，将内容腾出空间来了

[reference](https://mp.weixin.qq.com/s/U-txDYt0YqLh5EeFOcB4NQ) 


[【↥ back to top】](#目录)
# 第三回

在执行代码之前，因为所有的工作都是在内存中执行的，为了方便管理，要对内存的使用进行一个规划：
- 给寄存器赋值(cs:0x9000, ds:0x9000, ss:0x9000, es:0x9000, ip:0x9000, sp:0xFF00)
- 前面我们将代码挪动到了0x90000处，栈由指针控制，所以栈顶为0x9FF00

现在内存中寄存器布局位置如下：

```
栈顶 ss:sp   -->   0x9FF00 |    |
                           |    |
                           |    |
                           |    |
                           |    |
ss,ds,cs,ip,es --> 0x90000 |    |
```

> 1. 内存中很重要的三个片段: cs为代码段，ds为数据段，ss堆栈段
> ss为堆栈段，es为附加段，ip为指令指针
>
> 2. cs + ip 控制代码访问, ss + sp控制栈顶访问， ds控制数据访问， es先不用理会
>
> 3. 栈的位置要远远大于代码的位置0x90000，所以设置为0x9FF00,
>    保证栈向下发展不会碰到其他段

[reference](https://yidongmp.weixin.qq.com/s/90QBJ-lP_-du2qQJxNF-Fw) 


[【↥ back to top】](#目录)
# 第四回

上面代码中，代码已经做了：
1. 将启动部分代码从硬盘中第一扇区搬到了内存中
2. 对内存的使用做了初步的规划，代码段，数据段，堆栈段

接下来还有操作系统的其他代码，要从硬盘搬到内存中
